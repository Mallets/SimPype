.. _example_priority:

========
Priority
========

The scenario of the simulation is the following:

.. code-block :: none

   |Generator #0| \
                   )-> |Resource #0|
   |Generator #1| /

Where messages generated by ``Generator #0`` have higher priority than messages generated by ``Generator #1``.

.. code-block :: python

    import simpype
    import random

    # [Mandatory] Create a SimPype simulation object
    sim = simpype.Simulation(id = 'preemption')
    # [Optional] Fix the seed used by the pseudo-random generator
    sim.seed = 42
    # [Optional] Configure the path containting the models for the simulation. 
    # [Default] Current working directory
    sim.model.dir = 'examples/model'

    # Create a generator
    gen0 = sim.add_generator(id = 'gen0')
    # Assign an arrival time
    gen0.random['arrival'] = {0: lambda: random.expovariate(1.0/60)}
    gen0.message.property['priority'] = 0
    # Create a generator
    gen1 = sim.add_generator(id = 'gen1')
    # Assign an arrival time
    gen1.random['arrival'] = {0: lambda: random.expovariate(1.0/60)}
    gen1.message.property['priority'] = 1

    # Add a resource
    res0 = sim.add_resource(id = 'res0', pipe = 'p_priority')
    res0.random['service'] = {0: lambda: random.expovariate(1.0/90)}

    # Add a pipiline connecting the generator to the resource
    p0 = sim.add_pipeline(gen0, res0)
    p1 = sim.add_pipeline(gen1, res0)

    # Run until t=300
    sim.run(until = 300)

Where ``p_priority`` model is so implemented:

.. code-block :: python

    import simpype

    class Priority(simpype.pipe.Pipe):
        def __init__(self, sim, resource, id):
            super().__init__(sim, resource, id)
            self.add_queue(id = 'express')
            self.add_queue(id = 'fast')
            self.add_queue(id = 'slow')
            self.add_queue(id = 'background')

        @simpype.pipe.dequeue
        def dequeue(self):
            if len(self.queue['express']) > 0:
                m = self.queue['express'].pop()
            elif len(self.queue['fast']) > 0:
                m = self.queue['fast'].pop()
            elif len(self.queue['slow']) > 0:
                m = self.queue['slow'].pop()
            else:
                m = self.queue['background'].pop()
            return m

        @simpype.pipe.enqueue
        def enqueue(self, message):
            if 'priority' not in message.property:
                message.property['priority'] = 0

            if message.property['priority'].value == 3:
                m = self.queue['express'].push(message)
            elif message.property['priority'].value == 2:
                m = self.queue['fast'].push(message)
            elif message.property['priority'].value == 1:
                m = self.queue['slow'].push(message)
            elif message.property['priority'].value == 0:
                m = self.queue['background'].push(message)
            else:
                m = self.queue['background'].push(message)
            return m

    # Do NOT remove
    pipe = lambda *args: Priority(*args)

``sim.cfg`` stored under the ``log`` folder contains:

.. code-block :: none
  
    Simulation Seed: 42
    Simulation Time: 300.000000000
    Execution Time: 0.005500609 

``sim.log`` stored under the ``log`` folder contains:

.. code-block :: none

    timestamp,message,seq_num,resource,event
    0.000000000,gen0,0,res0,pipe.background.in
    0.000000000,gen1,0,res0,pipe.slow.in
    0.000000000,gen1,0,res0,pipe.slow.out
    1.519730343,gen1,1,res0,pipe.slow.in
    16.674901483,gen1,2,res0,pipe.slow.in
    28.946165767,gen1,0,res0,resource.serve
    28.946165767,gen1,1,res0,pipe.slow.out
    61.203617236,gen0,1,res0,pipe.background.in
    96.690461851,gen1,3,res0,pipe.slow.in
    102.147606128,gen1,4,res0,pipe.slow.in
    130.571736559,gen1,1,res0,resource.serve
    130.571736559,gen1,2,res0,pipe.slow.out
    133.294252507,gen1,2,res0,resource.serve
    133.294252507,gen1,3,res0,pipe.slow.out
    135.030375691,gen1,5,res0,pipe.slow.in
    155.498755144,gen1,3,res0,resource.serve
    155.498755144,gen1,4,res0,pipe.slow.out
    157.919251475,gen1,4,res0,resource.serve
    157.919251475,gen1,5,res0,pipe.slow.out
    177.265307363,gen1,6,res0,pipe.slow.in
    177.871501700,gen1,5,res0,resource.serve
    177.871501700,gen1,6,res0,pipe.slow.out
    194.840903210,gen0,2,res0,pipe.background.in
    209.782488348,gen0,3,res0,pipe.background.in
    240.234827437,gen1,7,res0,pipe.slow.in
    248.731134581,gen1,6,res0,resource.serve
    248.731134581,gen1,7,res0,pipe.slow.out
    249.317931751,gen1,7,res0,resource.serve
    249.317931751,gen0,0,res0,pipe.background.out
    263.171010726,gen0,4,res0,pipe.background.in
