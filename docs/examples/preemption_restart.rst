.. _example_preemption_restart:

=======================
Preemption with restart
=======================

The scenario of the simulation is the following:

.. code-block :: none

   |Generator #0| \
                   )-> |Resource #0|
   |Generator #1| /

Where messages generated by ``Generator #0`` preempt the messages generated by ``Generator #1`` while being served by ``Resource #0``.
In this example, ``Resource #0`` has no memory. Therefore, messages always spend a full service time regardless have already been preempted or not.

.. code-block :: python

    import simpype
    import random

    # [Mandatory] Create a SimPype simulation object
    sim = simpype.Simulation(id = 'preemption')
    # [Optional] Fix the seed used by the pseudo-random generator
    sim.seed = 42
    # [Optional] Configure the path containting the models for the simulation. 
    # [Default] Current working directory
    sim.model.dir = 'examples/model'

    # Create a generator
    gen0 = sim.add_generator(id = 'gen0')
    # Assign an arrival time
    gen0.random['arrival'] = {0: lambda: random.expovariate(1.0/60)}
    gen0.message.property['priority'] = 0
    # Create a generator
    gen1 = sim.add_generator(id = 'gen1')
    # Assign an arrival time
    gen1.random['arrival'] = {0: lambda: random.expovariate(1.0/60)}
    gen1.message.property['priority'] = 1

    # Add a resource
    res0 = sim.add_resource(id = 'res0', pipe = 'p_preemption')
    res0.random['service'] = {0: lambda: random.expovariate(1.0/90)}

    # Add a pipiline connecting the generator to the resource
    p0 = sim.add_pipeline(gen0, res0)
    p1 = sim.add_pipeline(gen1, res0)

    # Run until t=300
    sim.run(until = 300)

Where ``p_preemption`` model is so implemented:

.. code-block :: python

    import simpype

    class PriorityPreemption(simpype.Pipe):
        def __init__(self, sim, resource, id):
            super().__init__(sim, resource, id)     
            self.add_queue(id = 'preempted')
            self.add_queue(id = 'express')
            self.add_queue(id = 'fast')
            self.add_queue(id = 'slow')

        @simpype.pipe.dequeue
        def dequeue(self):
            if len(self.queue['express']) > 0:
                return self.queue['express'].pop()
            elif len(self.queue['preempted']) > 0:
                return self.queue['preempted'].pop()
            elif len(self.queue['fast']) > 0:
                return self.queue['fast'].pop()
            else:
                return self.queue['slow'].pop()

        @simpype.pipe.enqueue
        def enqueue(self, message):
            if 'priority' not in message.property:
                message.property['priority'] = 2

            if message.property['priority'].value == 0:
                m = self.queue['express'].push(message)
            elif message.property['priority'].value == 1:
                m = self.queue['fast'].push(message)
            elif message.property['priority'].value == 2:
                m = self.queue['slow'].push(message)
            else:
                m = self.queue['slow'].push(message)

            if isinstance(m, simpype.message.Message) and len(self.queue['express']) > 0:
                # Select the candidates to preempt
                tlist = [t for t in self.resource.task.values() if t.process.is_alive and \
                    t.message.property['priority'].value != 0]
                if len(tlist) > 0:
                    task = max(tlist, key = lambda task: task.message.property['priority'].value)
                    task.interrupt(cause = 'preempted')
                    self.queue['preempted'].push(task.message)
            return m

    # Do NOT remove
    pipe = lambda *args: PriorityPreemption(*args)

``sim.cfg`` stored under the ``log`` folder contains:

.. code-block :: none
   
   Simulation Seed: 42
   Simulation Time: 300.000000000
   Execution Time: 0.004591215

``sim.log`` stored under the ``log`` folder contains:

.. code-block :: none

    timestamp,message,seq_num,resource,event
    0.000000000,gen0,0,res0,pipe.express.in
    0.000000000,gen1,0,res0,pipe.fast.in
    0.000000000,gen0,0,res0,pipe.express.out
    1.519730343,gen1,1,res0,pipe.fast.in
    16.674901483,gen1,2,res0,pipe.fast.in
    28.946165767,gen0,0,res0,resource.serve
    28.946165767,gen1,0,res0,pipe.fast.out
    61.203617236,gen0,1,res0,pipe.express.in
    61.203617236,gen1,0,res0,pipe.preempted.in
    61.203617236,gen1,0,res0,resource.preempted
    61.203617236,gen0,1,res0,pipe.express.out
    69.389333651,gen0,1,res0,resource.serve
    69.389333651,gen1,0,res0,pipe.preempted.out
    96.690461851,gen1,3,res0,pipe.fast.in
    98.505472484,gen1,4,res0,pipe.fast.in
    113.308474241,gen1,5,res0,pipe.fast.in
    118.713487997,gen1,0,res0,resource.serve
    118.713487997,gen1,1,res0,pipe.fast.out
    121.133984328,gen1,1,res0,resource.serve
    121.133984328,gen1,2,res0,pipe.fast.out
    141.086234553,gen1,2,res0,resource.serve
    141.086234553,gen1,3,res0,pipe.fast.out
    155.543405913,gen1,6,res0,pipe.fast.in
    194.840903210,gen0,2,res0,pipe.express.in
    194.840903210,gen1,3,res0,pipe.preempted.in
    194.840903210,gen1,3,res0,resource.preempted
    194.840903210,gen0,2,res0,pipe.express.out
    202.783161168,gen1,7,res0,pipe.fast.in
    209.782488348,gen0,3,res0,pipe.express.in
    210.173686461,gen0,4,res0,pipe.express.in
    274.923686777,gen0,2,res0,resource.serve
    274.923686777,gen0,3,res0,pipe.express.out
